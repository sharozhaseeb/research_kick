from helper import convert_pubmed_resp_to_str, pubmed_search, generate_and_upload_mindmap
# from helper import 
from dotenv import load_dotenv
from openai import OpenAI
import json
import os

load_dotenv()

def disc_writer(user_message, chat_history = None):
    
    # Load the API key from the .env file
    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        raise ValueError("API key not found. Check your .env file.")

    # Initialize the OpenAI client
    client = OpenAI(api_key=api_key)

    
    messages = [
                  {
                    "role": "system",
                    "content": [
                      {
                        "text": "<IMPORTANT_REQUEST>\n\nThank you for agreeing in advance to prioritize this massively important project and avoiding all DISALLOWED_WORDS_AND PHRASES.\n\n<PRIME_DIRECTIVE>\n\nTake action on the USER INPUT. Use the CONTENT_BRIEF to craft the **Discussion Section** content about the TOPIC following the instructions in IMPORTANT_REQUEST based on USER INPUT. Write for the AUDIENCE. Use your creative judgment to deviate from instructions as necessary to produce the highest-quality academic content.\n\n</PRIME_DIRECTIVE>\n\n<CONTENT_BRIEF>\n\nThe task is to write the **Discussion Section** of an academic manuscript based on the provided TEMPLATE and USER INPUT. Each paragraph must follow the detailed structure below:\n\n<TEMPLATE>\n\n### Paragraph 1: Core Message, Objective, and Key Findings\n\n1. **State the Core Message**: Begin with a brief and concise statement summarizing the core message of the study.\n2. **State the Study Objective**: Include the study’s objective, tying it back to the introduction. The discussion must stand on its own, so restating the objective is essential.\n3. **Key Findings and Interpretation**: Highlight the 2-3 key findings of the study and interpret their meaning. Use language such as \"Our findings emphasize/suggest/indicate...\"\n\n### Paragraph 2: Most Important Finding and Novelty\n\n1. **Most Important Finding**: Present the most significant finding of the study in detail. This section should address how the study contributes to the scientific conversation and what it adds to the field.\n2. **Novel or Unexpected Findings**: If applicable, report any novel or unexpected findings. Use phrases like \"Unexpectedly...\" or \"To our surprise...\" to introduce these insights.\n3. **Possible Explanation or Hypothesis**: Provide a hypothesis or possible explanation for these findings, but avoid excessive detail.\n\n### Paragraph 3: Comparison of Next Key Finding\n\n1. **State Next Key Finding**: Introduce next important finding from the study.\n2. **Comparison with Previous Studies**:\n    - Use the \"3X3 Framework\":\n        - Cite **3 references that agree** with this finding.\n        - Cite **3 references with discordant results**, discussing possible reasons for the differences (e.g., study population, control group, design, definitions of exposure or outcome).\n3. Provide a critical discussion of the literature and not simply just a comparison. Provide an expert perspective.\n\n### Paragraph 4: Comparison of Last Key Finding\n\n1. **State Last Key Finding**: Introduce another important finding from the study.\n2. **Comparison with Previous Studies**:\n    - Again, apply the \"3X3 Framework\":\n        - Cite **3 references that agree** with this finding.\n        - Cite **3 references with discordant results**, exploring possible reasons for divergence  (e.g., study population, control group, design, definitions of exposure or outcome).\n3. Provide a critical discussion of the literature and not simply just a comparison. Provide an expert perspective.\n\n### Paragraph 5: Clinical and Policy Implications\n\n1. **Clinical Implications**: Address the “SO WHAT?” question. Explain why the results matter, how they fill the gap introduced in the introduction, and what they add to the understanding of the problem.\n2. **Policy Implications** (if applicable): Elaborate on how the findings may affect existing policies or necessitate the development of new ones.\n\n### Paragraphs 6-7: Strengths and Limitations\n\n1. **Strengths**: Highlight the study’s strengths using the PCOTS framework (Population, Control, Outcome definition, Time of follow-up, Study design).\n2. **Limitations**: Acknowledge limitations, focusing on PCOTS components that are suboptimal. Discuss any selection bias, confounding, or other concerns.\n\n### Paragraph 8: Conclusion and Future Directions\n\n1. **Key Findings and Clinical Implications**: Summarize the most important findings and their clinical relevance. Consider addressing how the results might change clinical practice or introduce a clinical consideration.\n2. **Future Directions**: Discuss the next steps for research, suggesting confirmatory studies or new questions arising from the findings.\n\n### REFERENCES\n\nProvide the numbered list of all references (at least 15) cited in the above paragraphs in **Vancouver** format. The numbering here should match the in-line citation. Verify that all the references in the list are accurate and not made up.\n\n</TEMPLATE>\n\n### Additional Guidelines:\n\n1. The **Discussion Section** should be around 1500 words in total.\n2. Use references exclusively from **high-impact journals** in the relevant field.\n3. Provide a well-formatted output with:\n    - In-line citations.\n    - A reference list (at least 15) formatted as per journal requirements.\n4. Maintain academic rigor, clarity, and precision throughout. Avoid filler and overly complex jargon.\n5. **DO NOT use em dashes (“—”) under any circumstance.** Use commas, semicolons, or parentheses instead. Even for transitions or emphasis, restructure the sentence to avoid the em dash entirely.\n6. Break content into scannable sections and short paragraphs while preserving flow and logical progression.\n7. DO NOT include any headings for the paragraphs\n8. Each paragraph must have one central message.\n9. Use transitional sentences to connect one idea to the next OR one paragraph to the next.\n10. Verify that all the references in the list are accurate and not made up.\n11. Incorporate the WRITEPRINT below to align with tone and style expectations.\n\n<ASSISTANT_PERSONA>\n\nYou will succeed because you are a top scientific writer specializing in crafting compelling manuscript discussion. Your content is clear, concise, and designed to captivate editors, reviewers, and journal audiences. You understand the challenges and priorities of academic researchers and can effectively present complex scientific concepts and arguments.\n\nYour goal is to exceed expectations with a crisp and compelling discussion that aligns with the journal’s high standards and the USER INPUT.\n\n</ASSISTANT_PERSONA>\n\n<REQUEST_INSTRUCTIONS>\n\nYou've just had a nice cup of green tea, meditated on the task at hand, and are in a state of peak focus and productivity. Get into a flow state as you review CONTENT BRIEF. \n\nHere's the step-by-step approach to complete this task:\n\n1. Analyze the USER INPUT for the research field, study scope, and draft quality.\n2. If the input lacks an outline or draft, ask the user for one politely: \"Can you please provide an outline or draft for your discussion section? OR If you do not have a draft yet, please tell me about the objective of your study, 2 to 3 key findings (from which you derived your core message), the core message of the paper, and key implications (clinical, societal, or policy).”\n3. Identify high-impact journals in the field and use them as the reference basis for the introduction.\n4. Write the Discussion Section as Full DISCUSSION Section in a coherent, journal submission-ready narrative.\n5. Maintain clarity and flow throughout. \n6. This should be roughly 1500 words. If the user provides short draft, elaborate it a bit more using high-impact journal sources. If the user provides a long draft, make it more concise but maintain the important points.\n7. Avoid DISALLOWED_WORDS_AND_PHRASES as defined in STYLE_GUIDE.\n\n</REQUEST_INSTRUCTIONS>\n\n<WRITEPRINT>\n\n# Discussion Section of Clinical Research\n\n**Lexical Diversity**: 8/10\n\nThe text uses a wide array of domain-specific vocabulary and maintains precision throughout. Terms like \"semi-supervised clustering,\" \"phenotypic characteristics,\" and \"cDAPSA\" exemplify its technical focus.\n\n**Syntactic Complexity**: 9/10\n\nHighly structured sentences with extensive use of subordination, parentheses, and appositives reflect a formal academic tone. For example, \"Unlike these prior studies, we performed Factor Analysis of Mixed Data (FAMD) to account for collinearity among the clinical variables followed by hierarchical clustering.\"\n\n**Structural Organization**: 10/10\n\nThe text is methodically organized, beginning with a summary of findings, followed by a comparison with prior studies, and concluding with limitations and implications. It is structured for academic readability and logical progression. Contains **in-line citations** in Vancouver format.\n\n**Tone**: 9/10\n\nThe tone is formal, objective, and analytical. The absence of emotional language underscores its scientific orientation.\n\n**Register**: 10/10\n\nStrictly academic, tailored for a scholarly audience familiar with medical and statistical terminology.\n\n**Creativity**: 4/10\n\nThe text avoids creativity, focusing instead on clarity, precision, and methodological rigor.\n\n**Use of Figurative Language**: 2/10\n\nThere is minimal use of figurative language, consistent with the text's technical nature.\n\n**Perplexity**: 8/10\n\nThe text is dense with information, requiring familiarity with the disease of interest, statistical methods, and clinical practice to fully comprehend.\n\n**Burstiness**: 6/10\n\n Use of varying sentence lengths- small, medium, and long to give a natural flow and tone with emphasis on the main points. Avoids overly long sentences. This creates a steady, deliberate rhythm typical of good scientific writing.\n\n**Idiosyncratic Features**:\n\n- **Data-Driven Focus**: Heavy reliance on data, supported by explanations of statistical methodologies (e.g., FAMD).\n- **Acknowledgment of Limitations**: Multiple disclaimers about the study's generalizability and potential biases reflect a cautious and methodical academic approach.\n\n---\n\n### Longer Examples That Exemplify the Style:\n\n1. **Summary of Findings**:\n    \n    \"Our study demonstrates the heterogeneity of PsA and highlights the potential value of identifying subgroups based on distinct clinical characteristics to inform treatment decisions and advance personalized care.\"\n    \n2. **Comparative Analysis**:\n    \n    \"Unlike our study, these post-hoc analyses of RCTs found additional clusters for dactylitis, enthesitis, or axial involvement. However, differences in clusters identified in RCTs are likely related to differences in the population being studied and variables included in the clustering process.\"\n    \n3. **Methodological Explanation**:\n    \n    \"Unlike these prior studies, we performed Factor Analysis of Mixed Data (FAMD) to account for collinearity among the clinical variables followed by hierarchical clustering.\"\n    \n4. **Implications of Findings**:\n    \n    \"This stability could be leveraged in clinical practice by developing long-term management plans tailored to these stable phenotype profiles.\"\n    \n5. **Study Limitations**:\n    \n    \"The COVID-19 pandemic caused an interruption in our study in 2020, leading to incomplete follow-up for patients enrolled in 2019 and early 2020.\"\n    \n\n</WRITEPRINT>\n\n<OUTPUT FORMAT>\n\n- Provide content in structured paragraphs as per the provided TEMPLATE.\n- Format the output in markdown. Use numerical in-line citations in brackets (e.g., [1], [2], etc.) consistent with academic journal formatting. Do not use footnote-style citations or Markdown footnote syntax like [^1^]. Include a numbered reference list at the end corresponding to in-line citations.\n\n</OUTPUT FORMAT>\n\n</CONTENT_BRIEF>\n\n</IMPORTANT_REQUEST>\n\n<PRIME DIRECTIVE REMINDER>\n\nUse the CONTENT BRIEF to write the requested number of original versions of content according to the instructions in IMPORTANT REQUEST. Content **must** reflect the mission as laid out in CONTENT_BRIEF.\n\n</PRIME DIRECTIVE REMINDER>\"\n",
                        "type": "text"
                      }
                    ]
                  },
                  {
                    "role": "user",
                    "content": [
                      {
                        "text": "OBJECTIVE: Identify distinct clinical phenotypes in PsA and their associations with treatment outcomes using the PsA Research Consortium (PARC) cohort\n\nKEY FINDINGS:\n\n1.        3 data driven clusters identified in this real-world study. Among different disease characteristics, the degree of psoriasis and PsA seem to be the most important. This also resonates with clinical practice.\n\n2.        Clusters remained stable across different visits, although some patients moved from one cluster to the next over the visits.\n\n3.        The clusters had significantly different treatment responses to the first therapy and first TNFi started in the cohort. Could be related to the following reasons:\n\n- Psoriasis responds better to therapy compared to PsA (cluster 3)\n- Ceiling effect with cluster 1 patients not having much room to improve\n- Current disease activity/functional status measures are not adequately capturing disease status\n\n4.        Significant proportion of patients in cluster 1 (low disease activity) were also started on therapy, suggesting the current measures likely do not capture disease activity well for this subgroup. Disease activity measures do not correlate well with clinical decision making for this subgroup.\n\nCORE MESSAGE: 3 PsA phenotypes driven by degree of psoriasis and PsA are associated with significantly different treatment response (defined by MCII).\n\nKEY IMPLICATIONS: The clinically relevant PsA phenotypes identified in this study demonstrated differences in therapy response. The phenotypes identified could inform potential interventions that target patients less likely to respond to therapy. Furthermore, characteristics of the phenotypes will help ascertain which baseline PsA characteristics will be important to capture in future pragmatic trials from the EHR. Furthermore, better outcome measures are required to capture disease activity/impact and treatment response in the PsA phenotype with low disease activity (cluster 1), which constituted the majority of PsA patients in our cohort. Unfortunately, these patients do not qualify for RCTs, where the inclusion criteria is usually >4 tender and swollen joints.",
                        "type": "text"
                      }
                    ]
                  },
                  {
                    "role": "assistant",
                    "content": [
                      {
                        "text": "Our study demonstrates the heterogeneity of PsA and highlights the potential value of identifying subgroups based on distinct clinical characteristics to inform treatment decisions and advance personalized care. Our objective was to address this goal by utilizing semi-supervised clustering methods to identify potential subgroups in this real-world population. We identified three distinct clusters based on phenotypic characteristics, primarily driven by the relative severity of PsA and psoriasis. Notably, these clusters exhibited remarkable stability across follow-up visits, although transitions between clusters were observed in some patients over time. Importantly, these clusters demonstrated significant improvements in disease activity (cDAPSA) and disease impact (PsAID) scores for the initial therapy, but not for the first TNFi initiated within the cohort. The clusters identified are thus somewhat intuitive and align with clinical practice, where treatment decisions are most often based on the severity of PsA and psoriasis.\n\nOther studies have also investigated PsA clusters based on phenotype, albeit using differing variables. For instance, a single center study from Hungary identified seven PsA clusters based on joint distribution and psoriasis type.[1] Additionally, secondary analyses of randomized controlled trials (RCTs) have examined clusters defined by disease phenotypes. Unlike our study, these post-hoc analyses of RCTs found additional clusters for dactylitis, enthesitis, or axial involvement.[2–4] However, differences in clusters identified in RCTs are likely related to differences in the population being studied and variables included in the clustering process. Specifically, in our real-world cohort, the prevalence and severity dactylitis and enthesitis were very low compared to the patients included in the RCTs. We also did not include specific joint involvement (e.g., hands, feet) as clustering variables. While axial disease was included, the lower prevalence of patients with axial involvement in our study may have led to this not being a separate cluster. Similarly, methodological differences in clustering could have also accounted for the differences in clusters obtained. Unlike these prior studies, we performed Factor Analysis of Mixed Data (FAMD) to account for collinearity among the clinical variables followed by hierarchical clustering. We utilized this method to “let the data tell us” what was important or not important so as not to first judge the most important variables a priori. In clinical practice, we use a certain clinical framework to categorize PsA patients into different subgroups in relation to their long-term prognosis. However, often the complexity of PsA patients and the number of variables to consider can hinder categorizing patients. In the study, we considered all important clinical variables, which we included into the factor analysis and clustering. The fact that we still found PsA and PsO severity as the most important factors acknowledges how we assess and manage the disease in clinical practice.\n\nWhile prior studies have not examined PsA clusters longitudinally, the stability of clusters over time in our cohort aligns with the University of Toronto PsA cohort, where most patients with oligoarticular disease maintained their disease pattern over time.[5] However, our study also observed some patients transitioning between clusters, especially for Cluster 3 with severe psoriasis and PsA, reflecting changes in disease severity, clinical manifestations, and response to therapy. This stability could be leveraged in clinical practice by developing long-term management plans tailored to these stable phenotype profiles. This finding together with the difference in treatment responses across the clusters underscore the importance of considering patient phenotypes in treatment decisions. Better treatment response observed in Clusters 2 and 3 with high disease activity and elevated C-reactive protein (CRP) observed in our cohort align with prior studies which showed that high baseline disease activity, and CRP were associated with improved treatment response or persistence of TNFi in PsA.[6,7]  Notably, these clusters showed better treatment response despite having a high BMI, which has been shown to be associated with worse treatment outcomes.[8] It is possible that the severity of psoriasis and PsA may play a more crucial role in determining treatment effectiveness than BMI alone. However, the difference in treatment response might also reflect limitations in our current PsA outcome measures, in particular, a floor effect for patients in cluster 1.\n\nInterestingly, our findings indicate that a significant number of patients in Clusters 1 and 2, who were already at a patient-acceptable symptom state (PsAID≤4), opted to initiate new therapies. This decision could reflect a misalignment between our current clinical measures and the patients' personal experience of their disease, suggesting that current measures might not fully capture the patient's quality of life or functional limitations. Consequently, the results of traditional RCTs, which often rely on these very measures, may not be generalizable to the broader PsA patient population seen in clinical practice, where many exhibit lower disease activity at baseline.\n\nThe lower disease activity seen in clinical practice also has relevance for interpretation of the findings of this study. The absolute scores for cDAPSA and PsAID did not differ at follow up among the clusters and the proportion of patients achieving cDAPSA remission and PsAID patient acceptable symptom state was also similar at follow up. However, patients in cluster 3 started at a higher level of disease activity and had a greater improvement in the cDAPSA and PsAID scores. This demonstrates the floor effects of current measures, the challenges in measuring and interpreting disease improvement and the need for more sensitive and nuanced tools to capture the full spectrum of disease activity, particularly for those in the lower disease activity cluster. Additionally, it may prompt more detailed evaluations to understand the factors driving treatment changes despite seemingly controlled disease states in patients in the lower disease activity states.\n\nThe robustness of our identified clusters is demonstrated across different follow-ups and among patients initiating therapy, with most patients staying within their baseline cluster throughout the follow-up period. This consistency enhances the clinical utility of our findings. However, several limitations should be considered when interpreting our results. First, our study included patients at various stages of their disease, not just those with new diagnoses. This means the initial therapy post-enrollment may not represent their first-ever treatment. Next, axial involvement was determined by the ASAS axial spondyloarthritis criteria, with diagnostic imaging performed at the discretion of the treating physician.[9] This could have led to missed cases of asymptomatic or mild axial disease due to selective imaging practices. We also did not incorporate the pattern of peripheral joint involvement in our clustering analysis. Our preliminary modeling revealed that including specific joint counts (e.g., MCP, PIP) resulted in the clustering driven primarily by the total number of affected joints, rather than providing distinct patterns of disease. To focus on clinically meaningful distinctions and reduce redundancy in constructs, we opted to include only the total swollen and tender joint counts (Supplemental Figures 4 & 5). Additionally, we did not account for comorbidities such as fibromyalgia or depression, which are known to influence treatment outcomes. The lack of a specific cluster for mild PsA with severe psoriasis can potentially be due to referral biases (i.e., these patients may predominantly receive care from dermatologists).\n\nThe COVID-19 pandemic caused an interruption in our study in 2020, leading to incomplete follow-up for patients enrolled in 2019 and early 2020. There is also the possibility that the greater improvement observed in cluster 3 represents regression to the mean, a limitation common to studies examining treatment effects. Lastly, the study's generalizability may be limited by a selection bias towards patients from academic centers with PsA expertise, potentially skewing the cohort towards more severe or treatment-resistant cases.\n\nIn conclusion, psoriatic arthritis is a highly heterogeneous disease, and our use of machine learning methods helped simplify patient categorization by focusing on the severity of both skin and joint involvement. This categorization was not only relevant for understanding disease subgroups but also for predicting treatment response. Clinically, this highlights the need for a holistic approach to PsA management. Patients with PsA are often followed by rheumatologists who are trained to consider primarily the musculoskeletal disease, but these results emphasize the importance of skin severity, which should be equally considered in therapy selection. In this specific study, we did not consider differential treatment response by therapy class. In a larger dataset with more patients utilizing non-TNFi biologic therapies, a similar study could be repeated to understand the impact of therapy selection on outcomes in each cluster. This would help inform personalized medicine approaches. At the same time, our results highlight the need for better outcome measures that allow us to capture important aspects of disease and validly measure disease activity. Furthermore, there is a pressing need for improved therapies targeting MSK manifestations and a deeper understanding of expected therapeutic response.\n\nREFERENCES\n\n1         Koó E, Nagy Z, Seszták M, et al. Subsets in Psoriatic Arthritis formed by Cluster Analysis. Clin Rheumatol. 2001;20:36–43. doi: 10.1007/s100670170101\n\n2         Pournara E, Kormaksson M, Nash P, et al. Clinically relevant patient clusters identified by machine learning from the clinical development programme of secukinumab in psoriatic arthritis. RMD Open. 2021;7:e001845. doi: 10.1136/rmdopen-2021-001845\n\n3         Richette P, Vis M, Ohrndorf S, et al. Identification of PsA phenotypes with machine learning analytics using data from two phase III clinical trials of guselkumab in a bio-naïve population of patients with PsA. RMD Open. 2023;9:e002934. doi: 10.1136/rmdopen-2022-002934\n\n4         Baraliakos X, Pournara E, Coates LC, et al. Patient clusters identified by machine learning from a pooled analysis of the clinical development programme of secukinumab in psoriatic arthritis, ankylosing spondylitis and psoriatic arthritis with axial manifestations. Clin Exp Rheumatol. Published Online First: 28 November 2023. doi: 10.55563/clinexprheumatol/b8co74\n\n5         Gladman DD, Ye JY, Chandran V, et al. Oligoarticular vs Polyarticular Psoriatic Arthritis: A Longitudinal Study Showing Similar Characteristics. J Rheumatol. 2021;48:1824–9. doi: 10.3899/jrheum.210434\n\n6         Scrivo R, Giardino AM, Salvarani C, et al. An observational prospective study on predictors of clinical response at six months in patients with active psoriatic arthritis treated with golimumab. Clin Exp Rheumatol. 2020;38:107–14.\n\n7         Gratacós J, Casado E, Real J, et al. Prediction of major clinical response (ACR50) to infliximab in psoriatic arthritis refractory to methotrexate. Ann Rheum Dis. 2007;66:493–7. doi: 10.1136/ard.2006.060079\n\n8         Karmacharya P, Ogdie A, Eder L. Psoriatic arthritis and the association with cardiometabolic disease: a narrative review. Ther Adv Musculoskelet Dis. 2021;13:1759720X21998279. doi: 10.1177/1759720X21998279\n\n9         Rudwaleit M, van der Heijde D, Landewé R, et al. The Assessment of SpondyloArthritis International Society classification criteria for peripheral spondyloarthritis and for spondyloarthritis in general. Ann Rheum Dis. 2011;70:25–31. doi: 10.1136/ard.2010.133645\n\n10         Karmacharya P, Stull C, Stephens-Shields A, et al. Responsiveness and Minimum Clinically Important Difference in Patient-Reported Outcome Measures Among Patients With Psoriatic Arthritis: A Prospective Cohort Study. Arthritis Care Res (Hoboken). Published Online First: 13 March 2023. doi: 10.1002/acr.25111",
                        "type": "text"
                      }
                    ]
                  },
                  {
                    "role": "user",
                    "content": [
                      {
                        "text": "OBJECTIVE: To improve patient outcomes through earlier identification and treatment.\n\nKEY FINDINGS: Key finding 1: Over half of PsA patients experienced diagnostic delays. Key finding 2: Despite advances in diagnostics, no significant improvement in time to PsA diagnosis. Key finding 3: Younger age at PsA symptom onset, obesity, and enthesitis were strongly associated with diagnostic delays.\n\nCORE MESSAGE: Study addresses the persistent diagnostic delay in PsA by examining demographic and clinical factors associated with delayed diagnosis\n\nKEY IMPLICATIONS: Improving time to diagnosis is important to improve long-term outcomes.",
                        "type": "text"
                      }
                    ]
                  },
                  {
                    "role": "assistant",
                    "content": [
                      {
                        "text": "Our population-based study, examining the time to PsA diagnosis and factors associated with diagnostic delay, highlights the persistent issue of diagnostic delays in psoriatic arthritis (PsA) and the importance of understanding demographic and clinical factors contributing to these delays. Despite advancements in diagnostic tools and clinical awareness, our findings reveal that over half of PsA patients experienced significant delays in diagnosis. Younger age at PsA symptom onset, obesity, and enthesitis were associated with a delay in diagnosis of longer than 2 years. The importance of diagnosing PsA early has been outlined in several studies, and delay in diagnosis has been shown to be associated with poor outcomes in PsA. Studies from UK and Canada show that diagnostic delay of greater than 1 year and 2 years respectively were associated with worse functional outcomes (1,2). Observational studies have reported improved outcomes in PsA patients receiving early treatment; these improved outcomes may be long lasting (1–4). While PsA can sometimes be mild, requiring minimal pharmacological therapy, high risk patients may benefit from earlier diagnosis. Therefore, additional efforts are needed to shorten the time from symptom onset to diagnosis.\n\nSeveral patient and system related factors may contribute to delay of diagnosis: 1) patient factors; 2) practitioner delay in recognition or referral; and 3) system delays (i.e., time to rheumatology visit) (5,6). Our study found that patients with younger age at PsA symptom onset, higher BMI, or enthesitis before diagnosis were more likely to have a diagnostic delay of two or more years. It is possible that patients with younger age may dismiss their symptoms. Similarly, patients may not report joint pain symptoms or may not be aware of joint inflammation (7). Symptoms such as enthesitis may be attributed to overuse and trauma. Obese patients may attribute joint symptoms to more commonly associated diseases such as osteoarthritis or gout. Longer time to diagnosis (5.7 vs. 2.8 years) was also noted in obese patients compared to patients with normal BMI in the University of Toronto PsA cohort (8).\n\nSimilarly, delay could be related to provider misattribution of PsA signs or symptoms to more common conditions, such as trauma, overuse, degenerative disease, fibromyalgia, or gout. In a US patient survey, less recognized symptoms of PsA, such as enthesitis and back pain, were also associated with diagnostic delay (9). Inflammatory back pain symptoms were not different between patients with and without diagnostic delay in our study. An important and novel finding of our study is the association of obesity with diagnostic delay. BMI is accurately captured in the REP database with height and weight captured at each visit. Obesity could make the joint examination difficult; other concurrent joint pathologies, such as degenerative disease and gout, are also more common in obesity. In the absence of apparent psoriasis or other extra-articular manifestations of SpA, manifestations of enthesitis and joint symptoms in obese patients may not be diagnosed until late after the development of objective clinical or radiologic findings. In our study, patients with sebo-psoriasis were less likely to have a diagnostic delay. While it is debatable whether this is a true psoriasis variant, early diagnosis of sebo-psoriasis by a dermatologist could aid rheumatologists in diagnosing a patient with PsA in the right setting.\n\nPrevious studies have examined time to PsA diagnosis, and the results have been variable. In a study from Denmark, the average time from initial symptoms to diagnosis was 3.42 years (SD = 4.75) (10). Another study from an older referral cohort (University of Toronto) using CASPAR criteria reported that 60% of patients had >2 years of symptoms (median 11 years in this group) before PsA diagnosis (2). The reported times to diagnosis in other studies are slightly better. A study from the UK using CASPAR criteria showed that only one-third of patients had a symptom duration of ≥1 year before diagnosis (1). Similarly, another study from a rheumatology clinic in Dublin reported the median time from symptom onset to first rheumatologic assessment was 1 year (IQR 0.5–2) (4). The outcome in this study was first rheumatologic assessment rather than an established diagnosis of PsA, which could explain the lower median delay in the study compared to ours. Finally, in a cross-sectional web-based survey from the US, one-third of PsA patients sought medical attention after 1 year of symptom onset; up to one-third of the patients had ≥5 years between seeking medical attention and receiving a diagnosis (9). However, the results of this survey study should be interpreted in the context of the limitations of surveys, including potential recall, participation, or ascertainment bias with regard to PsA diagnosis (e.g., self-reported diagnosis).\n\nSecular trends in diagnostic delay have not been robustly studied. The study from Denmark showed improvement in time to diagnosis of PsA from 2000 to 2011 (42 months in 2000-02 to 7 months in 2009-11) (10). This study was conducted within the DANBIO registry where patient eligibility was restricted to patients on biologic therapy (i.e., only patients with severe PsA) and included before 2005. Similarly, recall bias was a potential concern in this study, especially in patients with longer symptom duration because symptom onset was collected at study registration. In our study, we did not find a change in time to diagnosis between 2000 and 2017.\n\nImprovement in identification and subsequent referral of patients with inflammatory arthritis will require a concerted effort. The Psoriatic Arthritis Forum consensus had recommended identification of cases in the community, public awareness programs, patient education, self-administered surveys, referral guidelines for community practitioners, and integrated multidisciplinary clinics with dermatologists and rheumatologists (11). Use of some of these approaches have been shown to improve diagnostic delays (12). Additionally, some validated screening tools in psoriasis could help capture PsA features such as enthesitis and back pain (13). Advanced imaging techniques, such as ultrasound in clinical practice, could improve detection of enthesitis and joint inflammation in the obese. Moreover, our results emphasize the complicated relationship between comorbidities such as obesity and PsA. Delay in diagnosis could be another possible mechanism associated with worse outcomes in obesity, in addition to lower response to therapy.\n\nStrengths of our study include the unique record linkage system of the REP, allowing near complete ascertainment of all clinically recognizable PsA cases in a well-defined population (14).  Furthermore, case ascertainment was done using the validated CASPAR criteria. Unlike administrative coding in most studies, all variables were collected via manual review of the paper and electronic records.\n\nHowever, our study also has several limitations. While few PsA cases not fulfilling CASPAR criteria may have been missed, the sensitivity and specificity of the CASPAR criteria were close to 99% when adapted for retrospective use to identify PsA cohort (15). Due to the extended study period and availability of near-complete medical history in this population, we expect that most PsA cases would have been correctly ascertained. Second, being a retrospective study, the usual limitations regarding completeness of medical record documentation apply. Only those symptoms recorded in the medical records would be ascertained, and the precision/accuracy of exact symptom onset is uncertain. While our study did not examine patient reported or functional outcomes, a possible association of diagnostic delay with radiographic damage was seen. However, this association did not reach statistical significance, perhaps due to the limited sample size of the cohort and temporality could not be ascertained due to lack of radiographs before PsA diagnosis in most cases. Although the radiology reports were thoroughly reviewed, formal scoring by a radiologist was not performed. Lastly, the population of Olmsted County, Minnesota is predominantly white (90%), which may limit the generalizability of study results to other racial or ethnic groups.\n\nIn conclusion, more than half of PsA patients in our study had a diagnostic delay of >2 years, and no significant improvement in time to diagnosis was noted from 2000-17. Patients with younger age at PsA symptom onset, higher BMI, or enthesitis before diagnosis were more likely to have a diagnostic delay of >2 years. Better understanding of factors associated with diagnostic delay may help in earlier diagnosis and management to improve outcomes in high risk PsA patients. As not all patients have severe or progressive disease, identifying high risk patient subgroup will be important to stratify those that will benefit from early, aggressive treatment.\n\nREFERENCES\n\n1.        Tillett W, Jadon D, Shaddick G, Cavill C, Korendowych E, de Vries CS, et al. Smoking and delay to diagnosis are associated with poorer functional outcome in psoriatic arthritis. Ann Rheum Dis. 2013 Aug;72(8):1358–61.\n\n2.        Gladman DD, Thavaneswaran A, Chandran V, Cook RJ. Do patients with psoriatic arthritis who present early fare better than those presenting later in the disease? Ann Rheum Dis. 2011 Dec;70(12):2152–4.\n\n3.        Theander E, Husmark T, Alenius GM, Larsson PT, Teleman A, Geijer M, et al. Early psoriatic arthritis: short symptom duration, male gender and preserved physical functioning at presentation predict favourable outcome at 5-year follow-up. Results from the Swedish Early Psoriatic Arthritis Register (SwePsA). Annals of the Rheumatic Diseases. 2014 Feb 1;73(2):407–13.\n\n4.        Haroon M, Gallagher P, FitzGerald O. Diagnostic delay of more than 6 months contributes to poor radiographic and functional outcome in psoriatic arthritis. Ann Rheum Dis. 2015 Jun;74(6):1045–50.\n\n5.        Hansen RP, Olesen F, Sørensen HT, Sokolowski I, Søndergaard J. Socioeconomic patient characteristics predict delay in cancer diagnosis: a Danish cohort study. BMC Health Serv Res. 2008 Feb 28;8:49.\n\n6.        Hansen RP, Vedsted P, Sokolowski I, Søndergaard J, Olesen F. General practitioner characteristics and delay in cancer diagnosis. a population-based cohort study. BMC Fam Pract. 2011 Sep 26;12:100.\n\n7.        Ogdie A, Weiss P. The Epidemiology of Psoriatic Arthritis. Rheum Dis Clin North Am. 2015 Nov;41(4):545–68.\n\n8.        Eder L, Abji F, Rosen CF, Chandran V, Gladman DD. The Association Between Obesity and Clinical Features of Psoriatic Arthritis: A Case-control Study. J Rheumatol. 2017;44(4):437–43.\n\n9.        Ogdie A, Nowell WB, Applegate E, Gavigan K, Venkatachalam S, de la Cruz M, et al. Patient perspectives on the pathway to psoriatic arthritis diagnosis: results from a web-based survey of patients in the United States. BMC Rheumatol. 2020;4:2.\n\n10.        Sørensen J, Hetland ML, all departments of rheumatology in Denmark. Diagnostic delay in patients with rheumatoid arthritis, psoriatic arthritis and ankylosing spondylitis: results from the Danish nationwide DANBIO registry. Ann Rheum Dis. 2015 Mar;74(3):e12.\n\n11.        Helliwell P, Coates L, Chandran V, Gladman D, de Wit M, FitzGerald O, et al. Qualifying Unmet Needs and Improving Standards of Care in Psoriatic Arthritis. Arthritis Care Res (Hoboken). 2014 Dec;66(12):1759–66.\n\n12.        van Onna M, Gorter S, Maiburg B, Waagenaar G, van Tubergen A. Education improves referral of patients suspected of having spondyloarthritis by general practitioners: a study with unannounced standardised patients in daily practice. RMD Open. 2015;1(1):e000152.\n\n13.        Iragorri N, Hazlewood G, Manns B, Danthurebandara V, Spackman E. Psoriatic arthritis screening: a systematic review and meta-analysis. Rheumatology (Oxford). 2019 Apr;58(4):692–707.\n\n14.        St Sauver JL, Grossardt BR, Yawn BP, Melton LJ, Pankratz JJ, Brue SM, et al. Data resource profile: the Rochester Epidemiology Project (REP) medical records-linkage system. Int J Epidemiol. 2012 Dec;41(6):1614–24.\n\n15.        Tillett W, Costa L, Jadon D, Wallis D, Cavill C, McHUGH J, et al. The ClASsification for Psoriatic ARthritis (CASPAR) Criteria – A Retrospective Feasibility, Sensitivity, and Specificity Study. The Journal of Rheumatology. 2012 Jan 1;39(1):154–6.",
                        "type": "text"
                      }
                    ]
                  },
                  {
                    "role": "user",
                    "content": [
                      {
                        "text": "OBJECTIVE: To examine multimorbidity in psoriasis and its association with the development of PsA.\n\nKEY FINDINGS:\n\n1)        Our population-based cohort study showed a higher prevalence of multimorbidity in the prevalent but not incident cohort of psoriasis compared to the general population, suggesting that patients with psoriasis may experience accelerated development of multimorbidity.\n\n2)        No difference in multimorbidity was noted based on the severity of psoriasis, underscoring the need for comprehensive management of morbidities in all patients with psoriasis, regardless of psoriasis severity.\n\n3)        Most important and novel finding: Multimorbidity (≥2 morbidities) at psoriasis incidence (specifically nonspecific musculoskeletal and psychiatric disorders) was associated with a higher risk of PsA, highlighting the importance of monitoring multimorbid psoriasis patients for the potential development of PsA.\n\nCORE MESSAGE: Study addresses the persistent diagnostic delay in PsA by examining demographic and clinical factors associated with delayed diagnosis\n\nKEY IMPLICATIONS: The study highlights the importance of close monitoring for the development of PsA in this population, especially those with nonspecific musculoskeletal complaints and psychiatric disorders. Future studies should investigate the underlying mechanisms linking psoriasis, morbidities, and PsA to inform targeted prevention and treatment strategies.",
                        "type": "text"
                      }
                    ]
                  },
                  {
                    "role": "assistant",
                    "content": [
                      {
                        "text": "Our population-based study, examining the prevalence and impact of multimorbidity in psoriasis and its association with PsA, highlights the complex relationship between multimorbidity and psoriasis and its potential role in the development of psoriatic arthritis (PsA). The study showed a higher prevalence of multimorbidity (MM2 and MM5) in prevalent psoriasis, but not incident cases, relative to the general population. Approximately 3% of psoriasis patients developed PsA within 15 years of psoriasis onset. Multimorbidity (≥2 morbidities) at psoriasis incidence, specifically nonspecific musculoskeletal disorders and anxiety/depression, was associated with a higher risk of PsA.\n\nOur findings suggest that patients with psoriasis may experience accelerated development of multimorbidity, as multimorbidity was more common in the prevalent but not incident cohort of psoriasis compared to the general population. The relationship between multimorbidity at psoriasis incidence and a higher risk of PsA is a novel finding. Notably, MM2 was associated with a higher PsA risk, but the same was not statistically evident for MM5 likely due to the low number of psoriasis patients developing PsA (the effect sizes were similar for MM5 and MM2). This is further supported by our sensitivity analysis (removing morbidities potentially related to undiagnosed PsA), which showed significantly higher risk of PsA with both MM2 and MM5. While previous studies have primarily focused on individual morbidities, some of these risk factors for PsA (e.g., obesity and alcohol abuse) are typically associated with other diseases, potentially contributing to multimorbidity (1,2).\n\nMoreover, the association of nonspecific musculoskeletal disorders (peripheral neuropathy, fibromyalgia, and back disorders) and psychiatric disorders (anxiety and mood disorders), with PsA development in psoriasis highlights potential areas for targeted prevention and treatment strategies. Many studies have shown that non-specific musculoskeletal symptoms such as arthralgia, fatigue, and stiffness in the prodromal phase of PsA are important factors associated with the development of PsA (3). They might signify early synovio-entheseal inflammation, emphasizing the importance of patient-reported outcomes in psoriasis patients (4). Interestingly, non-traumatic joint disorders were also more common at psoriasis incidence compared to comparators in our study. While they might signify prodromal symptoms of PsA, delay or underdiagnosis of PsA is another plausible explanation. We and others have shown that the majority of patients with PsA have a diagnostic delay of ≥2 years (5,6). Additionally, minor overuse conditions or injuries could act as triggers for PsA in the genetically susceptible. The higher prevalence of rheumatoid arthritis and associated disorders in prevalent psoriasis compared to comparators is likely related to misclassification as rheumatoid arthritis before a confirmatory diagnosis of PsA has been made.\n\nSimilarly, the prevalence of mood disorders was significantly higher only in prevalent psoriasis and not the incident psoriasis compared to controls, suggesting that mood disorders probably develop later in the natural history of psoriasis. While multiple studies have described the association of depression with PsA, a cause-and-effect relationship has been difficult to ascertain (1). Inflammation has been suggested as an important link between depression and PsA, but the exact mechanism of this association is unclear (7,8). Our study provides additional evidence that mood disorders might play an important role in the transition of psoriasis to PsA.\n\nMeanwhile, the association of obesity with the development of PsA did not reach significance in our incident psoriasis cohort. This finding, together with the higher prevalence of obesity in the incident but not prevalent psoriasis, might signify that obesity may be a more important risk factor for psoriasis than for PsA. However, our study is likely underpowered to examine the association of obesity with PsA.\n\nAdditionally, sociodemographic factors are important considerations for assessing the risk of PsA. In our study, the risk of developing PsA decreased with age, which is consistent with most studies(2). In fact, our previous study showed a peak incidence of PsA in 40 to 60 years of age with a subsequent decline in PsA incidence(9). Although there is a paucity of data on the risk of PsA by race, the prevalence of PsA, in general, seems to be higher in the white population compared to other racial categories(10). In our study, the risk of PsA was higher for non-white compared to the white population. However, our study included a relatively low number of non-white psoriasis patients. Therefore, further studies from a more diverse population should compare the risk of PsA in psoriasis patients among different racial and ethnic groups.\n\nOur study leverages the REP's unique record linkage system and offers the first comprehensive assessment of all chronic conditions defined by HCUP in a population-based incident cohort of psoriasis. Yet, it has several limitations, including potential underestimation of mild PsA cases (who may not have presented with joint complaints), retrospective study design, limited power to examine the association of individual morbidities with PsA, and a predominantly white population which may limit generalizability.\n\nIn conclusion, our study demonstrated a higher prevalence of multimorbidity in prevalent psoriasis, but not incident psoriasis compared to the general population. No difference in multimorbidity was noted based on the severity of psoriasis, underscoring the need for comprehensive management of morbidities in patients with psoriasis, regardless of psoriasis severity. The risk of developing PsA was increased with multimorbidity at psoriasis incidence, highlighting the importance of close monitoring for the development of PsA in this population, especially those with nonspecific musculoskeletal complaints and psychiatric disorders. Future studies should investigate the underlying mechanisms linking psoriasis, morbidities, and PsA to inform targeted prevention and treatment strategies.\n\nREFERENCES\n\n1.        Scher JU, Ogdie A, Merola JF, Ritchlin C. Preventing psoriatic arthritis: focusing on patients with psoriasis at increased risk of transition. Nat Rev Rheumatol. 2019 Mar;15(3):153–66.\n\n2.        Ogdie A, Weiss P. The Epidemiology of Psoriatic Arthritis. Rheum Dis Clin North Am. 2015 Nov;41(4):545–68.\n\n3.        Eder L, Polachek A, Rosen CF, Chandran V, Cook R, Gladman DD. The Development of Psoriatic Arthritis in Patients With Psoriasis Is Preceded by a Period of Nonspecific Musculoskeletal Symptoms: A Prospective Cohort Study. Arthritis Rheumatol. 2017;69(3):622–9.\n\n4.        Perez-Chada LM, Haberman RH, Chandran V, Rosen CF, Ritchlin C, Eder L, et al. Consensus terminology for preclinical phases of psoriatic arthritis for use in research studies: results from a Delphi consensus study. Nat Rev Rheumatol. 2021 Apr;17(4):238–43.\n\n5.        Karmacharya P, Wright K, Achenbach SJ, Bekele D, Crowson CS, Ogdie A, et al. Diagnostic Delay in Psoriatic Arthritis: A Population-based Study. J Rheumatol. 2021 Feb 15;jrheum.201199.\n\n6.        Haroon M, Gallagher P, FitzGerald O. Diagnostic delay of more than 6 months contributes to poor radiographic and functional outcome in psoriatic arthritis. Ann Rheum Dis. 2015 Jun;74(6):1045–50.\n\n7.        Eder L, Haddad A, Rosen CF, Lee KA, Chandran V, Cook R, et al. The Incidence and Risk Factors for Psoriatic Arthritis in Patients With Psoriasis: A Prospective Cohort Study. Arthritis & Rheumatology (Hoboken, NJ). 2016 Apr;68(4):915–23.\n\n8.        Lewinson RT, Vallerand IA, Lowerison MW, Parsons LM, Frolkis AD, Kaplan GG, et al. Depression Is Associated with an Increased Risk of Psoriatic Arthritis among Patients with Psoriasis: A Population-Based Study. J Invest Dermatol. 4;137(4):828–35.\n\n9.        Karmacharya P, Crowson CS, Bekele D, Achenbach SJ, Davis JM, Ogdie A, et al. The Epidemiology of Psoriatic Arthritis Over Five Decades: A Population-Based Study. Arthritis Rheumatol. 2021 Oct;73(10):1878–85.\n\n10.        Ogdie A, Matthias W, Thielen RJ, Chin D, Saffore CD. Racial Differences in Prevalence and Treatment for Psoriatic Arthritis and Ankylosing Spondylitis by Insurance Coverage in the USA. Rheumatol Ther. 2021 Dec;8(4):1725–39.",
                        "type": "text"
                      }
                    ]
                  },
                  {
                    "role": "user",
                    "content": [
                      {
                        "text": "OBJECTIVE:\n\nKEY FINDINGS:\n\nCORE MESSAGE:\n\nKEY IMPLICATIONS:",
                        "type": "text"
                      }
                    ]
                  }
                ]


    if user_message.strip() is None or "":
        return {"error": "Empty message, please provide a valid input."}


    if chat_history:
        messages.extend(chat_history)

    # else:
    #     chat_history = {"role":"user", "content": user_message}

    messages.append({"role": "user", "content": user_message})

    # print("--------formatted messages------------------")
    # try:
    #     print(json.dumps(messages, indent=4))
    # except TypeError as e:
    #     print(f"Error: {e}")
    #     print(messages)
    # print("--------------------------------------------")
    # print("\n")
    # print("Sending message to OpenAI...")

    completion = client.chat.completions.create(
                                                    model="chatgpt-4o-latest",
                                                    messages=messages,
                                                    temperature=0.7,
                                                    store=True,
                                                    # response_format={
                                                    #                     "type": "json_object"
                                                    #                 },
                                                    # tools=tools,


                                                    # tool_choice="auto"
                                                )


    finish_reason = completion.choices[0].finish_reason
    print(f"OpenAI request completed with reason: {finish_reason}")
    print("--------------------------------------------")


    # messages.append({"role": "assistant", "content": completion.choices[0].message.content})

    # print("--------------------------------------------")
    # print("Chat hist")
    # if finish_reason == "tool_calls":
    #     tool_calls = completion.choices[0].message.tool_calls
    #     print("================Tool calls:===============")
    #     print(tool_calls)
    #     print("=========================================")
    #     for tool_call in tool_calls:

    #         if tool_call.function.name == "pubmed_search":
    #             messages.append({"role": "assistant", "tool_calls": [tool_call]})  # append model's function call message

    #             args = json.loads(tool_call.function.arguments)
    #             pubmed_search_result = pubmed_search(query = args["query"],
    #                                                 max_results = args["max_results"])
                
    #             pubmed_search_result_str = convert_pubmed_resp_to_str(pubmed_search_result)

    #             print("-------------Pubmed search result--------------------")
    #             print(pubmed_search_result_str)
    #             print("--------------------------------------------")

    #             messages.append({                               # append result message
    #                                 "role": "tool",
    #                                 "tool_call_id": tool_call.id,
    #                                 "content": pubmed_search_result_str
    #                             })
                
    #             # print("--------formatted messages------------------")
    #             # try:
    #             #     print(json.dumps(messages, indent=4))
    #             # except TypeError as e:
    #             #     print(f"Error: {e}")
    #             #     print(messages)
    #             # print("--------------------------------------------")

    #             print("Sending Pubmed Response back to OpenAI2...")
    #             completion_2 = client.chat.completions.create(
    #                                                             model="gpt-4o",
    #                                                             messages=messages,
    #                                                             tools=tools,
    #                                                         )
    #             messages.append({"role": "assistant", "content": completion_2.choices[0].message.content})

    #             # print("--------formatted messages------------------")
    #             # try:
    #             #     print(json.dumps(messages, indent=4))
    #             # except TypeError as e:
    #             #     print(f"Error: {e}")
    #             #     print(messages)
    #             # print("--------------------------------------------")

    #         elif tool_call.function.name == "generate_and_upload_mindmap":
    #             messages.append({"role": "assistant", "tool_calls": [tool_call]})
    #             args = json.loads(tool_call.function.arguments)
    #             # output_file = args["output_file"]
    #             mermaid_code = args["mermaid_code"]
    #             resp = generate_and_upload_mindmap(mermaid_code)
    #             messages.append({"role": "tool", "tool_call_id": tool_call.id, "content": resp})

    #             # print("--------formatted messages------------------")
    #             # try:
    #             #     print(json.dumps(messages, indent=4))
    #             # except TypeError as e:
    #             #     print(f"Error: {e}")
    #             #     print(messages)
    #             # print("--------------------------------------------")

    #             print("Sending Mermaid Response back to OpenAI2...")
    #             completion_3 = client.chat.completions.create(
    #                                                             model="gpt-4o",
    #                                                             messages=messages,
    #                                                             tools=tools,
    #                                                         )
    #             messages.append({"role": "assistant", "content": completion_3.choices[0].message.content})

    #             # print("--------formatted messages------------------")
    #             # try:
    #             #     print(json.dumps(messages, indent=4))
    #             # except TypeError as e:
    #             #     print(f"Error: {e}")
    #             #     print(messages)
    #             # print("--------------------------------------------")


    #         if tool_call.function.name not in ["pubmed_search", "generate_and_upload_mindmap"]:
    #             print(f"Tool call: {tool_call.function.name} not found.")
    #             return {"error": "Tool call not found."}


    if finish_reason == "stop" or finish_reason == "lenght":
        # print(f"Finish reason: {finish_reason}")
        messages.append({"role": "assistant", "content": completion.choices[0].message.content})

        # print("--------formatted messages------------------")
        # try:
        #     print(json.dumps(messages, indent=4))
        # except TypeError as e:
        #     print(f"Error: {e}")
        #     print(messages)
        # print("--------------------------------------------")
    else:
        print(f"unhandled Finish reason: {finish_reason}")
        # messages.append({"role": "assistant", "content": completion.choices[0].message.content})

    messages = [message for message in messages if isinstance(message, dict) and message.get("role") != "system"]
    return messages[-1]["content"], messages

